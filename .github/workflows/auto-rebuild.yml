name: Auto Rebuild PHIVE Validator

on:
  # Weekly rebuild - her Pazar gece 00:00 (UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # Manuel trigger
  workflow_dispatch:
  
  # phive-rules gÃ¼ncelleme kontrolÃ¼ (opsiyonel - external repo watch iÃ§in webhook gerekir)
  # repository_dispatch:
  #   types: [phive-rules-updated]

jobs:
  check-and-rebuild:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Check phive-rules for updates
        id: check-updates
        run: |
          # phive-rules son commit hash'ini kontrol et
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/phax/phive-rules/commits/master | jq -r '.sha')
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "Latest phive-rules commit: $LATEST_COMMIT"
          
          # Son build edilen commit'i kontrol et (varsa)
          if [ -f .last-build-commit ]; then
            LAST_BUILD=$(cat .last-build-commit)
            echo "Last build commit: $LAST_BUILD"
            if [ "$LATEST_COMMIT" == "$LAST_BUILD" ]; then
              echo "needs_rebuild=false" >> $GITHUB_OUTPUT
              echo "âœ… No updates needed - phive-rules unchanged"
            else
              echo "needs_rebuild=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Updates detected - rebuild needed"
            fi
          else
            echo "needs_rebuild=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• First build - no previous commit found"
          fi
      
      - name: Build and test Docker image
        if: steps.check-updates.outputs.needs_rebuild == 'true'
        run: |
          echo "ðŸ”¨ Building Docker image with latest phive-rules..."
          docker compose build --no-cache
          
          echo "âœ… Build completed successfully!"
          
          # Container'Ä± test et
          echo "ðŸ§ª Testing container..."
          docker compose up -d
          sleep 30
          
          # Health check
          if curl -f http://localhost/api; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed!"
            docker compose logs
            exit 1
          fi
          
          # KaÃ§ modÃ¼l yÃ¼klendi kontrol et
          MODULES_LOADED=$(docker compose logs phive-doc-validator 2>&1 | grep -oP "Modules loaded: \K\d+")
          echo "ðŸ“Š Modules loaded: $MODULES_LOADED"
          
          docker compose down
      
      - name: Save build commit hash
        if: steps.check-updates.outputs.needs_rebuild == 'true'
        run: |
          echo "${{ steps.check-updates.outputs.latest_commit }}" > .last-build-commit
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .last-build-commit
          git commit -m "chore: update last build commit [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Create release tag (optional)
        if: steps.check-updates.outputs.needs_rebuild == 'true'
        run: |
          TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Auto-rebuild with latest phive-rules"
          git push origin "$TAG_NAME" || echo "Tag already exists"
          echo "âœ… Created tag: $TAG_NAME"
      
      - name: Send notification (optional)
        if: steps.check-updates.outputs.needs_rebuild == 'true'
        run: |
          echo "ðŸ”” Rebuild completed successfully!"
          echo "Latest phive-rules commit: ${{ steps.check-updates.outputs.latest_commit }}"
          # Buraya Slack/Discord/Email notification eklenebilir
